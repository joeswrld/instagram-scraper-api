
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instagram Scraper API Tester with Billing</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 { font-size: 2em; margin-bottom: 10px; }
        .header p { opacity: 0.9; }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 30px;
        }

        .section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #e9ecef;
        }

        .section h2 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .form-group { margin-bottom: 20px; }

        label {
            display: block;
            margin-bottom: 8px;
            color: #495057;
            font-weight: 600;
            font-size: 0.9em;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea { resize: vertical; min-height: 100px; }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            width: 100%;
        }

        button:hover { transform: translateY(-2px); }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        .secondary-btn { background: #6c757d; margin-top: 10px; }

        .response-area {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            min-height: 300px;
            max-height: 500px;
            overflow: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .status-queued { background: #ffc107; color: #000; }
        .status-running { background: #17a2b8; color: #fff; }
        .status-completed { background: #28a745; color: #fff; }
        .status-failed { background: #dc3545; color: #fff; }
        .status-active { background: #28a745; color: #fff; }

        .job-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #dee2e6;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s;
        }

        .info-box, .warning-box, .error-box {
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
            font-size: 0.9em;
        }

        .info-box { background: #e7f3ff; border-left: 4px solid #2196F3; }
        .warning-box { background: #fff3cd; border-left: 4px solid #ffc107; color: #856404; }
        .error-box { background: #ffebee; border-left: 4px solid #f44336; color: #c62828; }

        .full-width { grid-column: 1 / -1; }

        .usage-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #e9ecef;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin: 5px 0;
        }

        .stat-label { color: #6c757d; font-size: 0.85em; }

        .plan-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 3px solid #667eea;
        }

        .cost-estimate {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 2px solid #ffc107;
        }

        @media (max-width: 768px) {
            .main-content { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Instagram Scraper API Tester</h1>
            <p>Test your API with real-time usage tracking & billing</p>
        </div>

        <div class="main-content">
            <!-- Configuration -->
            <div class="section">
                <h2>‚öôÔ∏è API Configuration</h2>
                <div class="form-group">
                    <label>API Base URL</label>
                    <input type="text" id="apiUrl" value="http://localhost:8000">
                </div>
                <div class="form-group">
                    <label>API Key</label>
                    <input type="text" id="apiKey" >
                </div>
                <button id="btnTest">Test Connection</button>
                <button id="btnUsage" class="secondary-btn">Load Usage & Plan</button>
            </div>

            <!-- Subscription Info -->
            <div class="section">
                <h2>üí≥ Your Subscription</h2>
                <div id="subscriptionInfo">
                    <p style="color: #6c757d;">Connect to API to view your plan</p>
                </div>
            </div>

            <!-- Usage Stats -->
            <div class="section full-width">
                <h2>üìä This Month's Usage</h2>
                <div id="usageStats">
                    <p style="color: #6c757d;">Load your usage summary to see stats</p>
                </div>
            </div>

            <!-- Create Job -->
            <div class="section full-width">
                <h2>üìã Create Scrape Job</h2>
                <div id="costEstimate"></div>
                
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 15px;">
                    <div class="form-group">
                        <label>Instagram URLs (one per line)</label>
                        <textarea id="urls" placeholder="https://www.instagram.com/p/ABC123/"></textarea>
                    </div>
                    <div>
                        <div class="form-group">
                            <label>Scrape Type</label>
                            <select id="scrapeType">
                                <option value="post">Post</option>
                                <option value="profile">Profile</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Export Format</label>
                            <select id="exportFormat">
                                <option value="json">JSON</option>
                                <option value="csv">CSV</option>
                            </select>
                        </div>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="includeMedia" checked>
                            Include Media (+50%)
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="includeComments" checked>
                            Include Comments (+25%)
                        </label>
                    </div>
                </div>
                <button id="btnCreate">üöÄ Start Scraping</button>
            </div>

            <!-- Job Status -->
            <div class="section full-width">
                <h2>üìä Job Status</h2>
                <div id="jobStatus">
                    <p style="color: #6c757d;">No active job</p>
                </div>
            </div>

            <!-- Response -->
            <div class="section full-width">
                <h2>üìÑ API Response</h2>
                <div class="response-area" id="response">Waiting for API call...</div>
            </div>

            <!-- All Jobs -->
            <div class="section full-width">
                <h2>üìë Recent Jobs</h2>
                <button id="btnList">Refresh Jobs List</button>
                <div id="jobsList" style="margin-top: 20px;">
                    <p style="color: #6c757d;">Click to load jobs</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentJobId = null;
        let statusInterval = null;
        let usageSummary = null;

        const getApiUrl = () => document.getElementById('apiUrl').value.replace(/\/$/, '');
        const getApiKey = () => document.getElementById('apiKey').value;

        function displayResponse(data, isError = false) {
            const el = document.getElementById('response');
            el.textContent = JSON.stringify(data, null, 2);
            el.style.borderLeft = isError ? '4px solid #dc3545' : '4px solid #28a745';
        }

        async function testConnection() {
            try {
                displayResponse({ status: 'Testing...' });
                const res = await fetch(getApiUrl() + '/');
                const data = await res.json();
                
                if (res.ok) {
                    displayResponse({ success: true, message: 'Connected!', data });
                    setTimeout(() => loadUsage(), 500);
                } else {
                    throw new Error('Connection failed');
                }
            } catch (error) {
                displayResponse({ success: false, error: error.message }, true);
            }
        }

        async function loadUsage() {
            try {
                const res = await fetch(getApiUrl() + '/usage/summary', {
                    headers: { 'X-API-Key': getApiKey() }
                });

                if (res.ok) {
                    usageSummary = await res.json();
                    displaySubscription(usageSummary);
                    displayUsageStats(usageSummary);
                    estimateCost();
                } else {
                    document.getElementById('subscriptionInfo').innerHTML = `
                        <div class="warning-box">
                            <strong>‚ö†Ô∏è No Account Found</strong><br>
                            Create an account: <code>python setup_accounts.py</code>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading usage:', error);
            }
        }

        function displaySubscription(data) {
            const sub = data.subscription;
            const cur = data.current_month;
            const pct = ((cur.included_used / sub.included_posts) * 100).toFixed(1);
            
            document.getElementById('subscriptionInfo').innerHTML = `
                <div class="plan-card">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                        <div>
                            <div style="font-size: 1.5em; font-weight: bold; color: #2c3e50;">${sub.tier_name}</div>
                            <div style="color: #6c757d; font-size: 0.9em;">${data.email}</div>
                        </div>
                        <div style="font-size: 1.2em; color: #667eea; font-weight: bold;">
                            $${sub.monthly_cost.toFixed(2)}/mo
                        </div>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <strong>${sub.included_posts.toLocaleString()} posts/month included</strong>
                            <span class="status-badge status-active">${sub.status}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${pct}%"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.9em; margin-top: 8px; color: #6c757d;">
                            <span>${cur.included_used.toLocaleString()} used</span>
                            <span>${cur.posts_remaining.toLocaleString()} remaining</span>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9em;">
                        <div><strong>Overage:</strong> ${cur.overage_posts.toLocaleString()} posts</div>
                        <div><strong>Days Left:</strong> ${cur.days_remaining}</div>
                        <div><strong>Overage Cost:</strong> $${cur.overage_cost.toFixed(2)}</div>
                        <div><strong>Total:</strong> <span style="color: #667eea; font-weight: bold;">$${cur.total_cost.toFixed(2)}</span></div>
                    </div>
                </div>
                ${cur.posts_remaining < 100 ? `
                    <div class="warning-box" style="margin-top: 15px;">
                        ‚ö†Ô∏è <strong>Running Low!</strong> Only ${cur.posts_remaining} posts remaining this month.
                    </div>
                ` : ''}
            `;
        }

        function displayUsageStats(data) {
            const cur = data.current_month;
            const life = data.lifetime;
            
            document.getElementById('usageStats').innerHTML = `
                <div class="usage-stats">
                    <div class="stat-card">
                        <div class="stat-label">Total Posts</div>
                        <div class="stat-value">${cur.total_posts.toLocaleString()}</div>
                        <div class="stat-label">this month</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Included Used</div>
                        <div class="stat-value">${cur.included_used.toLocaleString()}</div>
                        <div class="stat-label">of ${data.subscription.included_posts.toLocaleString()}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Overage</div>
                        <div class="stat-value" style="color: ${cur.overage_posts > 0 ? '#ffc107' : '#28a745'}">
                            ${cur.overage_posts.toLocaleString()}
                        </div>
                        <div class="stat-label">${cur.overage_posts > 0 ? 'extra' : 'none'}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">This Month</div>
                        <div class="stat-value" style="color: #667eea;">$${cur.total_cost.toFixed(2)}</div>
                        <div class="stat-label">total cost</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Lifetime</div>
                        <div class="stat-value" style="font-size: 1.5em;">${life.total_posts.toLocaleString()}</div>
                        <div class="stat-label">posts scraped</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">All Time</div>
                        <div class="stat-value" style="font-size: 1.5em;">$${life.total_spent.toFixed(2)}</div>
                        <div class="stat-label">total spent</div>
                    </div>
                </div>
            `;
        }

        async function estimateCost() {
            if (!usageSummary) return;
            
            const urls = document.getElementById('urls').value.split('\n')
                .map(u => u.trim()).filter(u => u.length > 0);
            
            if (urls.length === 0) {
                document.getElementById('costEstimate').innerHTML = '';
                return;
            }
            
            const includeComments = document.getElementById('includeComments').checked;
            const includeMedia = document.getElementById('includeMedia').checked;
            
            try {
                const res = await fetch(getApiUrl() + '/pricing/estimate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': getApiKey()
                    },
                    body: JSON.stringify({
                        num_posts: urls.length,
                        include_comments: includeComments,
                        include_media: includeMedia
                    })
                });
                
                const est = await res.json();
                const cur = usageSummary.current_month;
                const remaining = cur.posts_remaining;
                const useIncluded = Math.min(urls.length, remaining);
                const overage = Math.max(0, urls.length - remaining);
                
                document.getElementById('costEstimate').innerHTML = `
                    <div class="cost-estimate">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <strong>üìä Cost for ${urls.length} post${urls.length !== 1 ? 's' : ''}</strong>
                            <strong style="color: #667eea; font-size: 1.2em;">$${est.estimated_cost.toFixed(4)}</strong>
                        </div>
                        <div style="font-size: 0.9em; color: #6c757d; line-height: 1.6;">
                            ${useIncluded > 0 ? `‚úì ${useIncluded} from included (FREE)<br>` : ''}
                            ${overage > 0 ? `‚ö†Ô∏è ${overage} as overage @ $${est.cost_per_post.toFixed(4)}/post<br>` : ''}
                            ${includeComments ? 'üìù Comments (+25%)<br>' : ''}
                            ${includeMedia ? 'üì∑ Media (+50%)<br>' : ''}
                        </div>
                        ${overage === 0 ? `
                            <div style="margin-top: 10px; padding: 10px; background: #d4edda; border-radius: 4px; color: #155724;">
                                ‚úì All within included limit - no extra charge!
                            </div>
                        ` : `
                            <div style="margin-top: 10px; padding: 10px; background: #fff; border-radius: 4px;">
                                <strong>New Monthly Total:</strong> $${(cur.total_cost + est.estimated_cost).toFixed(2)}
                            </div>
                        `}
                    </div>
                `;
            } catch (error) {
                console.error('Estimate error:', error);
            }
        }

        async function createJob() {
            try {
                const urls = document.getElementById('urls').value.split('\n')
                    .map(u => u.trim()).filter(u => u.length > 0);

                if (urls.length === 0) {
                    alert('Enter at least one URL');
                    return;
                }

                const payload = {
                    urls,
                    scrape_type: document.getElementById('scrapeType').value,
                    export_format: document.getElementById('exportFormat').value,
                    include_media: document.getElementById('includeMedia').checked,
                    include_comments: document.getElementById('includeComments').checked
                };

                displayResponse({ status: 'Creating job...', payload });

                const res = await fetch(getApiUrl() + '/scrape', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': getApiKey()
                    },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();

                if (res.ok) {
                    currentJobId = data.job_id;
                    displayResponse({ success: true, message: 'Job created!', data });
                    startMonitoring();
                    setTimeout(() => loadUsage(), 1000);
                } else {
                    throw new Error(JSON.stringify(data));
                }
            } catch (error) {
                displayResponse({ success: false, error: error.message }, true);
            }
        }

        async function checkStatus(jobId = currentJobId) {
            if (!jobId) return;

            try {
                const res = await fetch(getApiUrl() + `/scrape/${jobId}`, {
                    headers: { 'X-API-Key': getApiKey() }
                });

                if (res.ok) {
                    const job = await res.json();
                    updateJobDisplay(job);
                    
                    if (job.status === 'completed') {
                        stopMonitoring();
                        loadUsage();
                    } else if (job.status === 'failed') {
                        stopMonitoring();
                    }
                }
            } catch (error) {
                console.error('Status error:', error);
            }
        }

        function updateJobDisplay(job) {
            const pct = job.progress.percentage.toFixed(1);
            let costInfo = '';
            
            if (job.cost_info) {
                costInfo = `
                    <div style="background: #d4edda; padding: 10px; border-radius: 4px; margin-top: 10px;">
                        <strong>üí∞ Cost:</strong> $${job.cost_info.actual_cost.toFixed(4)}<br>
                        <span style="font-size: 0.9em;">${job.cost_info.posts_scraped} posts scraped</span>
                    </div>
                `;
            }
            
            document.getElementById('jobStatus').innerHTML = `
                <div class="job-card">
                    <h3>Job: ${job.job_id}</h3>
                    <p>Status: <span class="status-badge status-${job.status}">${job.status.toUpperCase()}</span></p>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${pct}%"></div>
                    </div>
                    <p style="margin-top: 10px;">
                        Progress: ${job.progress.completed} / ${job.progress.total} (${pct}%)
                    </p>
                    ${job.error ? `<div class="error-box">${job.error}</div>` : ''}
                    ${costInfo}
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button id="btnRefresh" style="flex: 1;">Refresh</button>
                        ${job.status === 'completed' ? '<button id="btnDownload" style="flex: 1;">Download</button>' : ''}
                    </div>
                </div>
            `;

            const btnRef = document.getElementById('btnRefresh');
            if (btnRef) btnRef.onclick = () => checkStatus(job.job_id);

            const btnDl = document.getElementById('btnDownload');
            if (btnDl) btnDl.onclick = () => downloadResults(job.job_id);
        }

        function startMonitoring() {
            stopMonitoring();
            statusInterval = setInterval(() => checkStatus(), 3000);
        }

        function stopMonitoring() {
            if (statusInterval) {
                clearInterval(statusInterval);
                statusInterval = null;
            }
        }

        async function downloadResults(jobId) {
            try {
                const format = document.getElementById('exportFormat').value;
                const res = await fetch(getApiUrl() + `/scrape/${jobId}/results?format=${format}`, {
                    headers: { 'X-API-Key': getApiKey() }
                });

                if (res.ok) {
                    if (format === 'json') {
                        const data = await res.json();
                        displayResponse({ success: true, count: data.length, data });
                    } else {
                        const blob = await res.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `results_${jobId}.${format}`;
                        a.click();
                        window.URL.revokeObjectURL(url);
                        displayResponse({ success: true, message: 'Downloaded!' });
                    }
                }
            } catch (error) {
                displayResponse({ success: false, error: error.message }, true);
            }
        }

        async function listJobs() {
            try {
                const res = await fetch(getApiUrl() + '/jobs?limit=10', {
                    headers: { 'X-API-Key': getApiKey() }
                });

                const data = await res.json();
                displayResponse(data);

                if (data.jobs && data.jobs.length > 0) {
                    document.getElementById('jobsList').innerHTML = data.jobs.map(j => `
                        <div class="job-card">
                            <strong>${j.job_id}</strong>
                            <span class="status-badge status-${j.status}">${j.status}</span>
                            <div style="font-size: 0.9em; color: #6c757d; margin-top: 5px;">
                                ${j.completed_items}/${j.total_items} items
                            </div>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('jobsList').innerHTML = '<p style="color: #6c757d;">No jobs found</p>';
                }
            } catch (error) {
                displayResponse({ success: false, error: error.message }, true);
            }
        }

        // Event listeners
        document.getElementById('btnTest').onclick = testConnection;
        document.getElementById('btnUsage').onclick = loadUsage;
        document.getElementById('btnCreate').onclick = createJob;
        document.getElementById('btnList').onclick = listJobs;
        document.getElementById('urls').oninput = estimateCost;
        document.getElementById('includeMedia').onchange = estimateCost;
        document.getElementById('includeComments').onchange = estimateCost;

        // Auto-connect on load
        window.onload = testConnection;
    </script>
</body>
</html>